<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile MaxMetal</title>
    <link rel="icon" href="../static/img/logo-duże.png">
    <link rel="stylesheet" href="../static/style.css">
    <script>
function filterColumn(columnIndex) {
    let table = document.getElementById("tabela");
    let filterInputs = table.querySelectorAll("thead input");
    let filter = filterInputs[columnIndex].value.toLowerCase();
    let rows = table.getElementsByTagName("tbody")[0].getElementsByTagName("tr");

    for (let i = 0; i < rows.length; i++) {
        let cells = rows[i].getElementsByTagName("td");
        if (cells[columnIndex]) {
            let cellValue = cells[columnIndex].textContent || cells[columnIndex].innerText;
            rows[i].style.display = cellValue.toLowerCase().includes(filter) ? "" : "none";
        }
    }
}
function resetFilters() {
    let table = document.getElementById("tabela");
    let filterInputs = table.querySelectorAll("thead input");
    let rows = table.getElementsByTagName("tbody")[0].getElementsByTagName("tr");

    // Resetuj wszystkie pola filtrów
    filterInputs.forEach(input => input.value = "");

    // Przywróć widoczność wszystkich wierszy
    for (let i = 0; i < rows.length; i++) {
        rows[i].style.display = "";
    }
}
let sortStates = []; // Tablica przechowująca stan sortowania dla każdej kolumny

function sortTable(columnIndex) {
    const table = document.getElementById("tabela");
    const rows = Array.from(table.rows).slice(2); // Pobieramy wszystkie wiersze poza nagłówkami
    const tbody = table.tBodies[0];

    // Sprawdzamy, czy kolumna już istnieje w tablicy sortStates
    const existingSortIndex = sortStates.findIndex(sort => sort.columnIndex === columnIndex);

    if (existingSortIndex !== -1) {
        // Jeśli kolumna jest już sortowana, zmieniamy jej kierunek
        sortStates[existingSortIndex].ascending = !sortStates[existingSortIndex].ascending;
    } else {
        // Jeśli kolumna nie jest jeszcze sortowana, dodajemy ją na początek tablicy
        sortStates.unshift({ columnIndex, ascending: true });
    }

    // Sortowanie wierszy na podstawie stanu w tablicy sortStates
    rows.sort((rowA, rowB) => {
        for (const sort of sortStates) {
            const cellA = rowA.cells[sort.columnIndex]?.innerText.toLowerCase() || "";
            const cellB = rowB.cells[sort.columnIndex]?.innerText.toLowerCase() || "";

            if (!isNaN(cellA) && !isNaN(cellB)) {
                // Sortowanie liczb
                const comparison = sort.ascending ? cellA - cellB : cellB - cellA;
                if (comparison !== 0) return comparison;
            } else {
                // Sortowanie tekstowe
                const comparison = sort.ascending
                    ? cellA.localeCompare(cellB)
                    : cellB.localeCompare(cellA);
                if (comparison !== 0) return comparison;
            }
        }
        return 0; // Jeśli wszystkie kolumny są równe, nie zmieniamy kolejności
    });

    // Przypisanie posortowanych wierszy do tabeli
    tbody.innerHTML = "";
    rows.forEach(row => tbody.appendChild(row));

    // Resetowanie strzałek i ustawienie odpowiednich w nagłówkach
    Array.from(table.tHead.rows[1].cells).forEach((cell, index) => {
        cell.innerHTML = cell.innerHTML.replace(/ ▲| ▼/g, '');
        const sortState = sortStates.find(sort => sort.columnIndex === index);
        if (sortState) {
            cell.innerHTML += sortState.ascending ? ' ▲' : ' ▼';
        }
    });
}
function openEditModal(row) {
    const cells = row.getElementsByTagName('td');
    
    document.getElementById('editId').value = cells[0].textContent.trim();
    document.getElementById('editNazwaDostawcy').value = cells[1].textContent.trim();
    document.getElementById('editNazwaMaterialu').value = cells[2].textContent.trim();
    document.getElementById('editDataKregu').value = cells[3].textContent.trim();
    document.getElementById('editGrubosc').value = cells[4].textContent.trim();
    document.getElementById('editSzerokosc').value = cells[5].textContent.trim();
    document.getElementById('editWaga').value = cells[6].textContent.trim();
    document.getElementById('editNrEtykietaPaletowa').value = cells[7].textContent.trim();
    document.getElementById('editNrEtykietaKregu').value = cells[8].textContent.trim();
    document.getElementById('editLokalizacja').value = cells[9].textContent.trim();
    document.getElementById('editNrFaktury').value = cells[10].textContent.trim();
    document.getElementById('editDataDostawy').value = cells[11].textContent.trim();
    document.getElementById('editImie').value = cells[12].textContent.trim();
    document.getElementById('editNazwisko').value = cells[13].textContent.trim();

    // Pokaż modal
    document.getElementById('editModal').style.display = 'block';
    document.getElementById('overlay').style.display = 'block';
}

function closeModal() {
    document.getElementById('editModal').style.display = 'none';
    document.getElementById('overlay').style.display = 'none';
}
function saveChanges() {
    const data = {
        id: document.getElementById('editId').value,
        nazwa_dostawcy: document.getElementById('editNazwaDostawcy').value,
        nazwa_materialu: document.getElementById('editNazwaMaterialu').value,
        data_z_etykiety_na_kregu: document.getElementById('editDataKregu').value,
        grubosc: document.getElementById('editGrubosc').value,
        szerokosc: document.getElementById('editSzerokosc').value,
        waga_kregu: document.getElementById('editWaga').value,
        nr_etykieta_paletowa: document.getElementById('editNrEtykietaPaletowa').value,
        nr_z_etykiety_na_kregu: document.getElementById('editNrEtykietaKregu').value,
        lokalizacja: document.getElementById('editLokalizacja').value,
        nr_faktury_dostawcy: document.getElementById('editNrFaktury').value,
        data_dostawy: document.getElementById('editDataDostawy').value,
        pracownik_imie: document.getElementById('editImie').value,
        pracownik_nazwisko: document.getElementById('editNazwisko').value,
    };

    fetch('/save', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data),
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            alert('Dane zostały zapisane.');
            location.reload(); // Odśwież tabelę po zapisaniu
        } else {
            alert('Wystąpił błąd przy zapisywaniu danych.');
        }
    });

    closeModal();
}
let isDragging = false; // Czy okno jest przeciągane
let offsetX, offsetY;   // Przesunięcie kursora względem okna

const modal = document.getElementById('editModal');
const header = document.getElementById('modalHeader');

// Funkcja uruchamiana po rozpoczęciu przeciągania
header.addEventListener('mousedown', (e) => {
    isDragging = true;
    offsetX = e.clientX - modal.offsetLeft;
    offsetY = e.clientY - modal.offsetTop;
    document.body.style.userSelect = 'none'; // Zablokowanie zaznaczania tekstu
    e.preventDefault(); // Zapobieganie domyślnemu zachowaniu
});

// Funkcja uruchamiana podczas przeciągania
document.addEventListener('mousemove', (e) => {
    if (isDragging) {
        modal.style.left = `${e.clientX - offsetX}px`;
        modal.style.top = `${e.clientY - offsetY}px`;
        modal.style.transform = 'none'; // Wyłącz domyślną transformację
    }
});

// Funkcja kończąca przeciąganie
document.addEventListener('mouseup', () => {
    isDragging = false;
    document.body.style.userSelect = ''; // Przywrócenie możliwości zaznaczania tekstu
});
// Funkcja do załadowania danych do formularza
function editRecord(record) {
    document.getElementById("editId").value = record.id;
    document.getElementById("editNazwaDostawcy").value = record.nazwa_dostawcy;
    document.getElementById("editNazwaMaterialu").value = record.nazwa_materialu;
    document.getElementById("editDataKregu").value = record.data_z_etykiety_na_kregu;
    document.getElementById("editGrubosc").value = record.grubosc;
    document.getElementById("editSzerokosc").value = record.szerokosc;
    document.getElementById("editWaga").value = record.waga_kregu;
    document.getElementById("editNrEtykietaPaletowa").value = record.nr_etykieta_paletowa;
    document.getElementById("editNrEtykietaKregu").value = record.nr_z_etykiety_na_kregu;
    document.getElementById("editLokalizacja").value = record.lokalizacja;
    document.getElementById("editNrFaktury").value = record.nr_faktury_dostawcy;
    document.getElementById("editDataDostawy").value = record.data_dostawy;
    document.getElementById("editImie").value = record.pracownik_imie;
    document.getElementById("editNazwisko").value = record.pracownik_nazwisko;
    
    // Wyświetlenie modala
    document.getElementById("editModal").style.display = "block";
}

// Funkcja do zapisywania zmian
function saveChanges() {
    const id = document.getElementById("editId").value;
    const nazwa_dostawcy = document.getElementById("editNazwaDostawcy").value;
    const nazwa_materialu = document.getElementById("editNazwaMaterialu").value;
    const data_z_etykiety_na_kregu = document.getElementById("editDataKregu").value;
    const grubosc = document.getElementById("editGrubosc").value;
    const szerokosc = document.getElementById("editSzerokosc").value;
    const waga_kregu = document.getElementById("editWaga").value;
    const nr_etykieta_paletowa = document.getElementById("editNrEtykietaPaletowa").value;
    const nr_z_etykiety_na_kregu = document.getElementById("editNrEtykietaKregu").value;
    const lokalizacja = document.getElementById("editLokalizacja").value;
    const nr_faktury_dostawcy = document.getElementById("editNrFaktury").value;
    const data_dostawy = document.getElementById("editDataDostawy").value;
    const pracownik_imie = document.getElementById("editImie").value;
    const pracownik_nazwisko = document.getElementById("editNazwisko").value;

    // Wysłanie danych do serwera
    fetch('/update-record', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            id,
            nazwa_dostawcy,
            nazwa_materialu,
            data_z_etykiety_na_kregu,
            grubosc,
            szerokosc,
            waga_kregu,
            nr_etykieta_paletowa,
            nr_z_etykiety_na_kregu,
            lokalizacja,
            nr_faktury_dostawcy,
            data_dostawy,
            pracownik_imie,
            pracownik_nazwisko
        })
    })
    .then(response => response.json())
    .then(data => {
        console.log(data);
        // Możesz dodać kod do aktualizacji UI po zapisaniu zmian
        closeModal(); // Zamknięcie modala
    })
    .catch(error => {
        console.error('Error:', error);
    });
}

// Funkcja do zamykania modala
function closeModal() {
    document.getElementById("editModal").style.display = "none";
}
    </script>
</head>
<body>
    <div id="strona">
        <div id="banner">
            <div id="menu-main">
                <nav role="navigation">
                    <div id="menuToggle">
                        <input type="checkbox" id="menuCheckbox">

                        <span></span>
                        <span></span>
                        <span></span>

                        <ul id="menu">
                            {% if not g.user %}
                        
                            <li>
                                <a href="{{ url_for('login') }}"><label for="menuCheckbox" onclick="this.parentNode.click();">Zaloguj się!</label></a>
                            </li>
                        
                            
                        {% else %}
                        <li>
                            <a href="{{ url_for('logout') }}"><label for="menuCheckbox" onclick="this.parentNode.click();">Wyloguj się</label></a>
                        </li>
                        {% endif %}
                        {% if g.user.id_uprawnienia==1 %}
                        <li>
                            <a href="{{ url_for('register') }}"><label for="menuCheckbox" onclick="this.parentNode.click();">Zarejestruj się!</label></a>
                        </li>
                        {% endif %}
                        <li>
                            <a href=javascript:history.back();><label for="menuCheckbox" onclick="this.parentNode.click();">Powrót</label></a>
                        </li>
                            <li>
                                <a href="{{ url_for('contact') }}">
                                    <label for="menuCheckbox" onclick="this.parentNode.click();">Kontakt do nas!</label>
                                </a>
                            </li>
                            
                            <li>
                                <img id="logo1" src="../static/img/logo-duże.png" alt="logo">
                            </li>
                        </ul>   
                    </div>
                </nav>
                <div id="logo-banner">
                    <a href="{{ url_for('home') }}"><img id="logo-duże" src="../static/img/logo-duże.png" alt="logo"></a>
                </div>
                <div id="avatar">
                    {% if g.user %}
                        {% if g.user.zdj_profilowe_base64 %}
                            <a href="{{url_for('uzytkownik')}}"><img id="user" src="data:image/jpeg;base64,{{ g.user.zdj_profilowe_base64 }}" alt="Zdjęcie profilowe" /></a>
                        {% else %}
                            <a href="{{url_for('uzytkownik')}}"><img id="user" src="../static/img/user.jpg" alt="Zdjęcie domyślne" /></a>
                        {% endif %}
                {% else %}
                    <a href="{{ url_for('login') }}"><img id="user" src="../static/img/nie zalogowany.png" alt="Zdjęcie domyślne" /></a>
                {% endif %}
                </div>
            </div>
        </div>
        
            <div id="content">
                <div id="title">
                    {% if user %}
                    <h2 id="witaj">Witaj, {{ user.imie }}!</h2>    
                {% endif %}
                </div>
            </div>
            <hr>
           <div>
            <table id="tabela">
                <thead>
                    <tr>
                        <th><input type="text" placeholder="Filtruj ID" onkeyup="filterColumn(0)"></th>
                        <th><input type="text" placeholder="Filtruj Dostawcę" onkeyup="filterColumn(1)"></th>
                        <th><input type="text" placeholder="Filtruj Materiał" onkeyup="filterColumn(2)"></th>
                        <th><input type="text" placeholder="Filtruj Datę Kręgu" onkeyup="filterColumn(3)"></th>
                        <th><input type="text" placeholder="Filtruj Grubość" onkeyup="filterColumn(4)"></th>
                        <th><input type="text" placeholder="Filtruj Szerokość" onkeyup="filterColumn(5)"></th>
                        <th><input type="text"     placeholder="Filtruj Wagę" onkeyup="filterColumn(6)"></th>
                        <th><input type="text" placeholder="Filtruj Etyk. Paletową" onkeyup="filterColumn(7)"></th>
                        <th><input type="text" placeholder="Filtruj Etyk. Kręgu" onkeyup="filterColumn(8)"></th>
                        <th><input type="text" placeholder="Filtruj Lokalizację" onkeyup="filterColumn(9)"></th>
                        <th><input type="text" placeholder="Filtruj Fakturę" onkeyup="filterColumn(10)"></th>
                        <th><input type="text" placeholder="Filtruj Datę Dostawy" onkeyup="filterColumn(11)"></th>
                        <th><input type="text" placeholder="Filtruj Imię" onkeyup="filterColumn(12)"></th>
                        <th><input type="text" placeholder="Filtruj Nazwisko" onkeyup="filterColumn(13)"></th>
                        <th><button onclick="resetFilters()">Usuń Filtry</button></th>
                    </tr>
                    <tr>
                        <th onclick="sortTable(0)">ID &#9650;&#9660;</th>
            <th onclick="sortTable(1)">Nazwa Dostawcy &#9650;&#9660;</th>
            <th onclick="sortTable(2)">Nazwa Materiału &#9650;&#9660;</th>
            <th onclick="sortTable(3)">Data z Etykiety na Kręgu &#9650;&#9660;</th>
            <th onclick="sortTable(4)">Grubość &#9650;&#9660;</th>
            <th onclick="sortTable(5)">Szerokość &#9650;&#9660;</th>
            <th onclick="sortTable(6)">Waga Kręgu &#9650;&#9660;</th>
            <th onclick="sortTable(7)">Nr Etykieta Paletowa &#9650;&#9660;</th>
            <th onclick="sortTable(8)">Nr z Etykiety na Kręgu &#9650;&#9660;</th>
            <th onclick="sortTable(9)">Lokalizacja &#9650;&#9660;</th>
            <th onclick="sortTable(10)">Nr Faktury Dostawcy &#9650;&#9660;</th>
            <th onclick="sortTable(11)">Data Dostawy &#9650;&#9660;</th>
            <th onclick="sortTable(12)">Imię Pracownika &#9650;&#9660;</th>
            <th onclick="sortTable(13)">Nazwisko Pracownika &#9650;&#9660;</th>
            <th>Edycja</th>
                    </tr>
                </thead>
                <tbody>
                    {% for tasmy in tasma %}
                        {%if tasmy.pracownik.id_uprawnienia!=1%}
                            {%if tasmy.pracownik.id==g.user.id%}
                    <tr>
                        <td>{{ tasmy.id }}</td>
                        <td>{{ tasmy.nazwa_dostawcy }}</td>
                        <td>{{ tasmy.nazwa_materialu }}</td>
                        <td>{{ tasmy.data_z_etykiety_na_kregu }}</td>
                        <td>{{ tasmy.grubosc }}</td>
                        <td>{{ tasmy.szerokosc }}</td>
                        <td>{{ tasmy.waga_kregu }}</td>
                        <td>{{ tasmy.nr_etykieta_paletowa }}</td>
                        <td>{{ tasmy.nr_z_etykiety_na_kregu }}</td>
                        <td>{{ tasmy.lokalizacja }}</td>
                        <td>{{ tasmy.nr_faktury_dostawcy }}</td>
                        <td>{{ tasmy.data_dostawy }}</td>
                        <td>{{ tasmy.pracownik.imie }}</td>
                        <td>{{ tasmy.pracownik.nazwisko }}</td>
                        <td><button onclick="openEditModal(this.parentElement.parentElement)">Edytuj</button></td>
                    </tr>
                            {%endif%}
                        {%else%}
                        <tr>
                            <td>{{ tasmy.id }}</td>
                            <td>{{ tasmy.nazwa_dostawcy }}</td>
                            <td>{{ tasmy.nazwa_materialu }}</td>
                            <td>{{ tasmy.data_z_etykiety_na_kregu }}</td>
                            <td>{{ tasmy.grubosc }}</td>
                            <td>{{ tasmy.szerokosc }}</td>
                            <td>{{ tasmy.waga_kregu }}</td>
                            <td>{{ tasmy.nr_etykieta_paletowa }}</td>
                            <td>{{ tasmy.nr_z_etykiety_na_kregu }}</td>
                            <td>{{ tasmy.lokalizacja }}</td>
                            <td>{{ tasmy.nr_faktury_dostawcy }}</td>
                            <td>{{ tasmy.data_dostawy }}</td>
                            <td>{{ tasmy.pracownik.imie }}</td>
                            <td>{{ tasmy.pracownik.nazwisko }}</td>
                            <td><button onclick="openEditModal(this.parentElement.parentElement)">Edytuj</button></td>
                        </tr>
                        {%endif%}
                    {% endfor %}
                </tbody>
            </table>
           </div> 

        </div>
        <div id="editModal" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:#fff; padding:20px; border:1px solid #ccc; box-shadow:0px 0px 10px rgba(0,0,0,0.5); z-index:1000; max-height:90%; overflow-y:auto;">
            <div id="modalHeader" style="cursor:move; background:#f1f1f1; padding:10px; font-weight:bold;">Przeciągnij, aby przesunąć</div>
            <form id="editForm">
                <h3>Edytuj Wiersz</h3>
                <label for="editId">ID:</label>
                <input type="text" id="editId" name="id" readonly><br><br>
                
                <label for="editNazwaDostawcy">Nazwa Dostawcy:</label>
                <input type="text" id="editNazwaDostawcy" name="nazwa_dostawcy"><br><br>
                
                <label for="editNazwaMaterialu">Nazwa Materiału:</label>
                <input type="text" id="editNazwaMaterialu" name="nazwa_materialu"><br><br>
                
                <label for="editDataKregu">Data z Etykiety na Kręgu:</label>
                <input type="text" id="editDataKregu" name="data_z_etykiety_na_kregu"><br><br>
                
                <label for="editGrubosc">Grubość:</label>
                <input type="text" id="editGrubosc" name="grubosc"><br><br>
                
                <label for="editSzerokosc">Szerokość:</label>
                <input type="text" id="editSzerokosc" name="szerokosc"><br><br>
                
                <label for="editWaga">Waga Kręgu:</label>
                <input type="text" id="editWaga" name="waga_kregu"><br><br>
                
                <label for="editNrEtykietaPaletowa">Nr Etykieta Paletowa:</label>
                <input type="text" id="editNrEtykietaPaletowa" name="nr_etykieta_paletowa"><br><br>
                
                <label for="editNrEtykietaKregu">Nr z Etykiety na Kręgu:</label>
                <input type="text" id="editNrEtykietaKregu" name="nr_z_etykiety_na_kregu"><br><br>
                
                <label for="editLokalizacja">Lokalizacja:</label>
                <input type="text" id="editLokalizacja" name="lokalizacja"><br><br>
                
                <label for="editNrFaktury">Nr Faktury Dostawcy:</label>
                <input type="text" id="editNrFaktury" name="nr_faktury_dostawcy"><br><br>
                
                <label for="editDataDostawy">Data Dostawy:</label>
                <input type="text" id="editDataDostawy" name="data_dostawy"><br><br>
                
                <label for="editImie">Imię Pracownika:</label>
                <input type="text" id="editImie" name="pracownik_imie"><br><br>
                
                <label for="editNazwisko">Nazwisko Pracownika:</label>
                <input type="text" id="editNazwisko" name="pracownik_nazwisko"><br><br>
                
                <button type="button" onclick="saveChanges()">Zapisz</button>
                <button type="button" onclick="closeModal()">Anuluj</button>
            </form>
        </div>
        <div id="overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:999;" onclick="closeModal()"></div>       
        
        <footer id="footer">
            <div id="footer1"> 
                <h3>Kontakt bezpośredni</h3>
                <div id="kontakt-mail">
                    <p> E-mail:</p> 
                    <p>a.grobelny@zset.leszno.pl</p>
                    <p>j.kaczmarek@zset.leszno.pl</p>
                    <p>d.bondar@zset.leszno.pl</p>
                </div>
                <div id="kontakt-tel">
                    <p>Tel:</p> 
                    <p>+48 608 344 209</p>
                    <p>+48 609 578 204</p>
                    <p>+48 731 571 182</p>
                </div>
            </div>
            <div id="footer2">
                <p>Copyright © 2025 Lump Store. Wszelkie prawa autorskie zastrzeżone. Jakiekolwiek rozpowszechnianie informacji i tekstów zabronione</p>
            </div>
        </footer>
    </div>
</body>
</html> 